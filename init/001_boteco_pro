CREATE SCHEMA IF NOT EXISTS boteco_pro;
SET search_path TO boteco_pro;

CREATE TABLE "user" (
    user_id     UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email       TEXT UNIQUE NOT NULL CHECK (email <> ''),
    password_hash TEXT NOT NULL,
    display_name  TEXT,
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE TRIGGER trg_user_updated
BEFORE UPDATE ON "user"
FOR EACH ROW EXECUTE FUNCTION set_updated_at();

CREATE TABLE boteco (
    boteco_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    owner_user_id UUID NOT NULL,
    name          TEXT NOT NULL CHECK (name <> ''),
    slug          TEXT NOT NULL UNIQUE CHECK (slug <> ''),
    logo_url      TEXT,
    timezone      TEXT DEFAULT 'Europe/Lisbon',

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT fk_boteco_owner
        FOREIGN KEY (owner_user_id)
        REFERENCES user(user_id)
        ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_boteco_slug ON boteco(slug);

CREATE TRIGGER trg_boteco_updated
BEFORE UPDATE ON boteco
FOR EACH ROW EXECUTE FUNCTION set_updated_at();


CREATE TABLE staff (
    staff_id   UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    boteco_id  UUID NOT NULL,
    user_id    UUID NOT NULL,
    role       TEXT NOT NULL,
    active     BOOLEAN DEFAULT TRUE,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CONSTRAINT fk_staff_boteco
        FOREIGN KEY (boteco_id)
        REFERENCES boteco(boteco_id)
        ON UPDATE CASCADE ON DELETE CASCADE,

    CONSTRAINT fk_staff_user
        FOREIGN KEY (user_id)
        REFERENCES user(user_id)
        ON UPDATE CASCADE ON DELETE CASCADE,

    CONSTRAINT staff_unique_per_boteco
        UNIQUE(boteco_id, user_id)
);

CREATE INDEX idx_staff_boteco ON staff(boteco_id);
CREATE INDEX idx_staff_user   ON staff(user_id);

CREATE TRIGGER trg_staff_updated
BEFORE UPDATE ON staff
FOR EACH ROW EXECUTE FUNCTION set_updated_at();
